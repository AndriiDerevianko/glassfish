{
    "jpsType": "install",
    "jpsVersion": "0.7",
    "application": {
        "name": "Glassfish Cluster",
        "version": "1.0.0",
        "env": {
            "topology": {
                "nodes": [{
                    "nodeType": "docker",
                    "extip": false,
                    "displayName": "das",
                    "nodeGroup": "das",
                    "cloudlets": 32,
                    "docker": {
                        "image": "andretadeu/glassfish",
                        "env": {
                            "DAS": "true"
                        },
                        "registry": {
                            "url": "registry.hub.docker.com"
                        }
                    }
                },
                {
                    "nodeType": "docker",
                    "extip": false,
                    "displayName": "worker",
                    "nodeGroup": "cp",
                    "cloudlets": 24,
                    "count": 2,
                    "docker": {
                        "image": "andretadeu/glassfish",
                        "links": ["das:das"],
                        "registry": {
                            "url": "registry.hub.docker.com"
                        }
                    }
                },
                {
                    "nodeType": "docker",
                    "extip": true,
                    "cloudlets": 16,
                    "count": 1,
                    "displayName": "LoadBalancer",
                    "nodeGroup": "bl",
                    "docker": {
                        "image": "andretadeu/haproxy-managed-lb",
                        "volumes" : ["/usr/local/etc/haproxy"],
                        "env": {
                            "HOSTS_PORT": "28080"
                        }
                    }
                }]
            },
            "onBeforeScaleIn[nodeGroup:cp]": {
                "forEach(event.response.nodes)": {
                    "execCmd": {
                        "nodeId": "${@i.id}",
                        "commands": "cd / && ./run.sh gf:stop"
                    }
                }
            },
            "onAfterScaleOut[nodeGroup:cp]": {
                "call": [
                    "addClusterMembers"
                ]
            },
            "onAfterScaleIn[nodeGroup:cp]": {
                "forEach(event.response.nodes)": {
                    "execCmd": {
                        "nodeGroup": "bl",
                        "commands": [
                            "/root/lb_manager.sh --removehost ${@i.intIP}"
                        ]
                    }
                }
            }
        },
        "onInstall": [{
            "call": [
                "addClusterMembers"
            ],
            "executeScript": {
                "type": "js",
                "script": "https://download.jelastic.com/public.php?service=files&t=ffbf704b963644640d8bbc5ef809604b&download",
                "params": {
                    "nodeGroup": "das",
                    "name": "GlassFishAdminPort",
                    "port": "4848"
                }
            }
        }],
        "procedures": [{
            "id": "addClusterMembers",
            "onCall": {
                "forEach(nodes.cp)": {
                    "execCmd": {
                        "nodeGroup" : "bl",
                        "commands": [
                            "/root/lb_manager.sh --addhosts ${@i.intIP}"
                        ]
                    }
                }
            }
        }]
    }
}
